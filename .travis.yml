language: node_js
node_js: 13
os: linux

install:
  - npm install -g gulp-cli
  - npm install

jobs:
  include:
    - stage: "Build"
      name: "Run ESLint"
      script: node_modules/.bin/eslint src/js/*.js

    - stage: "Build"
      name: "Run Gulp"
      script: gulp

    - stage: "Deploy to GitHub"
      if: tag IS present
      name: "Deploy"
      script: gulp
      before_deploy:
        - export CLEAN_VERSION=${TRAVIS_TAG//v/}
        - sed -i.bak "s/#APPVERSION#/$CLEAN_VERSION/" build/*.php
        - rm build/*.bak
        - export ZIP_FILENAME="np2-wallboard-${TRAVIS_TAG}"
        - mkdir $ZIP_FILENAME
        - cp README.md LICENSE $ZIP_FILENAME
        - mv build ${ZIP_FILENAME}/public
        - zip -qr ${ZIP_FILENAME}.zip $ZIP_FILENAME
      deploy:
        provider: releases
        token:
          secure: "RcRedrZHzznLH25b7a39Fz9I9Wqn38ATVtrFPZVle6bn3Sbl+PbT40lFa3bNvIelYegYuE4GbAqACFs6GukBhvSCEuU0GGkgzDgPzAaP2MzWAOp0Im17h8QbGvSRRWlwxndE3CZ+exNOiaDeSgHkXWfPzym+QYWaKZXkJKDMLha4riT1lkfCAPqJXO3RsE6w9lEcd6LkiSHiTP+ltXcj3dYBIuEYGzrW1kKfatv380XCeNUwqGg2EjHSO/ujf0s9SfjQmJrPTrVNJ2Ovfn0KcVDnp/8LyDufdoFqyqg3WhZBtA7CBYJ5ZGp1SEQLuBWGO2+Xg/f+MCTCLKkvwdHcRJg8P6ODX8B7LQ6YZHm9H+OY7SnESeO6TLFUb/1ANkkSB0CQTkgRbnQLsPD80xtLnf0Nf/pqehDhi5nMif1uqE31uSuJbZcOrUHSwQ+k/+wXevd7fh9JE/JMePKiW9tbPcO+hua9VXC6HQt85PW+WjM7dL24WNgwc3BbrbQVfFbHEYrFz5As4JTiwqt1ql5nmOJ3kE+K+9DbvlJZjlaDKFKW72JIHCn5H8hDbbrG94j0mUXA1Th0ciFD3MTcYLvCoZruHoZq2ZHTiIHq3PbO2g/83jSn10kVdJjFl5ehGpmjCubWBVUoyxQfHcdeqYtjrZnW7JHeJ/PDGJMt2uS2K4s="
        file: "${ZIP_FILENAME}.zip"
        name: "$TRAVIS_TAG"
        skip_cleanup: true
        draft: true
        overwrite: true
        on:
          tags: true
